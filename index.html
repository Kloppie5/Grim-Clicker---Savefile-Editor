<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
    <script>
      function parseIni ( text, debug = false ) {
        const out = Object.create(null)
        let pointer = out
        let section = null
        const lines = text.split(/[\r\n]+/g)
        for ( const line of lines ) {
          let match = line.match(/^\[([^\]]*)\]$/i)
          if ( match ) { // Section header
            if ( debug )
              console.log(`Section: ${match[1]}`)
            section = match[1]
            pointer = out[section] = Object.create(null)
            continue
          }

          match = line.match(/^([\w\.\-]+)\s*=\s*(.*)$/)
          if ( match ) {
            if ( debug )
              console.log(`${match[1]}: ${match[2]}`)
            const key = match[1]
            const value = match[2].replace(/^"(.*)"$/, '$1')
            pointer[key] = value
            continue
          }

          if ( debug )
            console.log(`Skipping: ${line}`)
        }
        return out
      }
      function decryptBase64 ( text ) {
        return CryptoJS.enc.Base64.parse(text).toString(CryptoJS.enc.Utf8)
      }
      function decrypt ( savefile ) {
        var decrypted = decryptBase64(savefile)
        var parsed = parseIni(decrypted)

        parsed.SV.galo = decryptBase64(parsed.SV.galo)
        parsed.SV.galo = parseIni(parsed.SV.galo)

        parsed.SV.save = decryptBase64(parsed.SV.save)
        parsed.SV.save = parseIni(parsed.SV.save)

        console.log(parsed)
      }
      async function loadSave ( event ) {
        const file = event.target.files.item(0)
        const contents = await file.text()
        document.getElementById('savefile-input').value = contents
        document.getElementById('savefile-output').value = contents
        decrypt(contents)
      }
      function download ( ) {
        var a = document.createElement("a");
        a.href = "data:text/plain;charset=utf-8," + encodeURIComponent(document.getElementById('savefile-output').value);
        a.download = "grim-custom.save";
        a.click();
      }
    </script>
  </head>
  <body>
    <input type="file" onchange="loadSave(event)"/><br>
    <textarea id="savefile-input" style="width: 500px; height: 100px;"></textarea><br>
    <textarea id="savefile-output" style="width: 500px; height: 100px;"></textarea><br>
    <input type="button" value="Download" onclick="download()"/><br>
  </body>
</html>
